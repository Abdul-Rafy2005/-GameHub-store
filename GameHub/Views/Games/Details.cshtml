@model GameHub.Models.Game
@{
    ViewBag.Title = Model.Title;
    var isAuth = (Session["IsAuthenticated"] as bool?) ?? false;
    var isAdmin = ((Session["UserType"] as string) ?? "").Equals("Admin", StringComparison.OrdinalIgnoreCase);
    var libraryStatus = ViewBag.LibraryStatus as string ?? "none";
    var avg = (decimal)(ViewBag.AverageRating ?? 0m);
    var reviewCount = (int)(ViewBag.FeedbackCount ?? 0);
    var feedbacks = ViewBag.Feedbacks as IEnumerable<GameHub.Models.GameFeedback> ?? Enumerable.Empty<GameHub.Models.GameFeedback>();
    var isUpcoming = Model.ReleaseDate.HasValue && Model.ReleaseDate.Value.Date > DateTime.UtcNow.Date;
}

<!-- Hero Banner -->
<section class="game-hero" style="background-image:url('/Content/banners/@(Model.GameID).jpg')">
    <div class="hero-overlay"></div>
    <div class="hero-content container-xl">
        <div class="hero-left">
            <div class="cover-wrapper">
                <img src="/Content/covers/@(Model.GameID).jpg" onerror="this.src='/Content/cover-placeholder.jpg'" alt="@Model.Title Cover" class="hero-cover" />
                @if (libraryStatus == "owned") { <span class="ownership-ribbon owned"><i class="bi bi-check2-circle"></i> Owned</span> }
                else if (libraryStatus == "wishlist") { <span class="ownership-ribbon wishlist"><i class="bi bi-bookmark-fill"></i> Wishlist</span> }
                @if (isUpcoming) { <span class="ownership-ribbon wishlist" style="top:auto;bottom:10px;">Releases @(Model.ReleaseDate.HasValue ? Model.ReleaseDate.Value.ToString("MMM dd, yyyy") : "TBA")</span> }
            </div>
        </div>
        <div class="hero-right">
            <h1 class="game-title-display">@Model.Title</h1>
            <div class="meta-line">
                <span class="meta-item"><i class="bi bi-tag"></i> @(Model.Genre1?.GenreName ?? "Uncategorized")</span>
                <span class="meta-sep">•</span>
                <span class="meta-item"><i class="bi bi-calendar"></i> @(Model.ReleaseDate.HasValue ? Model.ReleaseDate.Value.ToString("MMM dd, yyyy") : "TBA")</span>
                @if (avg > 0) { <span class="meta-sep">•</span><span class="meta-item"><i class="bi bi-star-fill text-warning"></i> @avg / 5 (@reviewCount)</span> }
            </div>
            <p class="game-short-desc">@(Model.Description ?? "No description available.")</p>

            <div class="action-block">
                @if (!isAdmin)
                {
                    if (libraryStatus == "owned")
                    {
                        <button class="btn btn-success btn-lg mb-2" disabled><i class="bi bi-check-circle"></i> You Own This</button>
                        <div><a href="@Url.Action("Index","UserLibraries")" class="link-accent small"><i class="bi bi-collection"></i> View in Library</a></div>
                    }
                    else if (libraryStatus == "wishlist")
                    {
                        <button class="btn btn-info btn-lg mb-2" disabled><i class="bi bi-bookmark-check"></i> In Wishlist</button>
                        <div><a href="@Url.Action("Index","UserLibraries")" class="link-accent small"><i class="bi bi-credit-card"></i> Purchase from Library</a></div>
                    }
                    else
                    {
                        if (isUpcoming)
                        {
                            <div class="mb-2">
                                <button class="btn btn-secondary btn-lg" disabled><i class="bi bi-hourglass-split"></i> Releases @(Model.ReleaseDate.HasValue ? Model.ReleaseDate.Value.ToString("MMM dd, yyyy") : "TBA")</button>
                            </div>
                            <div class="small text-muted">This title is not yet available for purchase. Add to wishlist will be enabled once the game releases.</div>
                        }
                        else
                        {
                            if (isAuth)
                            {
                                using (Html.BeginForm("AddToLibrary", "Games", FormMethod.Post, new { @class = "d-inline" }))
                                {
                                    @Html.AntiForgeryToken()
                                    @Html.Hidden("gameId", Model.GameID)
                                    <button type="submit" class="btn btn-accent btn-lg"><i class="bi bi-plus-circle"></i> Add to Wishlist - $@Model.Price</button>
                                }
                            }
                            else
                            {
                                <button type="button" class="btn btn-accent btn-lg" onclick="requireLogin()"><i class="bi bi-lock"></i> Add to Wishlist - $@Model.Price</button>
                            }
                        }
                    }
                }
                else
                {
                    <a href="@Url.Action("Edit","Games", new { id = Model.GameID })" class="btn btn-warning btn-lg"><i class="bi bi-pencil"></i> Edit Game</a>
                }
            </div>
            <div class="price-line mt-2"><span class="price-tag">$@Model.Price</span> @if (Model.IsAvailable ?? false){<span class="availability badge bg-success ms-2"><i class="bi bi-check-circle"></i> Available</span>} else {<span class="availability badge bg-secondary ms-2"><i class="bi bi-x-circle"></i> Unavailable</span>}</div>
        </div>
    </div>
</section>

<!-- Main Layout -->
<div class="container-xl mt-4">
    <div class="row g-4">
        <div class="col-lg-8">
            <!-- Screenshots / Media -->
            <div class="panel-dark glassy p-3 mb-4">
                <h5 class="section-heading"><i class="bi bi-images"></i> Media</h5>
                <div class="screenshot-strip">
                    <img src="/Content/screens/@(Model.GameID)_1.jpg" onerror="this.style.display='none'" />
                    <img src="/Content/screens/@(Model.GameID)_2.jpg" onerror="this.style.display='none'" />
                    <img src="/Content/screens/@(Model.GameID)_3.jpg" onerror="this.style.display='none'" />
                </div>
                <div class="text-muted small mt-2">More screenshots coming soon.</div>
            </div>

            <!-- Reviews -->
            <div class="panel-dark glassy p-3">
                <h5 class="section-heading"><i class="bi bi-chat-square-quote"></i> User Reviews (@reviewCount)</h5>
                @if (feedbacks.Any())
                {
                    <div class="reviews-flow">
                        @foreach (var f in feedbacks)
                        {
                            <div class="review-card">
                                <div class="review-head">
                                    <div class="review-user"><i class="bi bi-person-circle"></i> @f.User.FullName</div>
                                    <div class="review-date text-muted">@(f.FeedbackDate.HasValue ? f.FeedbackDate.Value.ToString("MMM dd, yyyy") : "")</div>
                                </div>
                                <div class="review-rating">@string.Join("", Enumerable.Repeat("⭐", f.Rating ?? 0))</div>
                                @if (!string.IsNullOrWhiteSpace(f.Review))
                                {
                                    <div class="review-text">@f.Review</div>
                                }
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="empty-reviews text-center py-4">
                        <i class="bi bi-chat-left-text display-6 text-muted"></i>
                        <p class="mt-2 text-muted">No reviews yet. Be the first to review this game!</p>
                    </div>
                }
            </div>
        </div>
        <div class="col-lg-4">
            <!-- Details / Stats -->
            <div class="panel-dark glassy p-3 mb-4">
                <h5 class="section-heading"><i class="bi bi-info-circle"></i> Details</h5>
                <ul class="detail-list">
                    <li><span>Genre</span><strong>@(Model.Genre1?.GenreName ?? "N/A")</strong></li>
                    <li><span>Release Date</span><strong>@(Model.ReleaseDate.HasValue ? Model.ReleaseDate.Value.ToString("MMMM dd, yyyy") : "TBA")</strong></li>
                    <li><span>Price</span><strong>$@Model.Price</strong></li>
                    <li><span>Average Rating</span><strong>@avg / 5 (@reviewCount)</strong></li>
                </ul>
            </div>

            <!-- Feedback Form -->
            @if (isAuth && !isAdmin)
            {
                <div class="panel-dark glassy p-3">
                    <h5 class="section-heading"><i class="bi bi-chat-left-text"></i> Leave Feedback</h5>
                    @if (TempData["FeedbackError"] != null) { <div class="alert alert-danger">@TempData["FeedbackError"]</div> }
                    @if (TempData["FeedbackSuccess"] != null) { <div class="alert alert-success">@TempData["FeedbackSuccess"]</div> }
                    @using (Html.BeginForm("SubmitFeedback", "Games", FormMethod.Post, new { @class = "feedback-form" }))
                    {
                        @Html.AntiForgeryToken()
                        @Html.Hidden("gameId", Model.GameID)
                        <div class="mb-2">
                            <label class="form-label small">You</label>
                            <div class="form-control-plaintext text-info"><i class="bi bi-person-circle"></i> @Session["UserName"]</div>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small">Rating</label>
                            <select name="rating" class="form-control form-control-dark">
                                <option value="5" selected>⭐⭐⭐⭐⭐ Excellent</option>
                                <option value="4">⭐⭐⭐⭐ Good</option>
                                <option value="3">⭐⭐⭐ Average</option>
                                <option value="2">⭐⭐ Poor</option>
                                <option value="1">⭐ Terrible</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">Review (Optional)</label>
                            <textarea name="review" class="form-control form-control-dark" rows="3" placeholder="Share your thoughts..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-accent w-100"><i class="bi bi-send"></i> Submit Review</button>
                    }
                </div>
            }
        </div>
    </div>

    <div class="mt-4 text-center">
        <a href="@Url.Action("Index","Games")" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Back to Store</a>
    </div>
</div>

@section Styles {
<style>
.game-hero { position: relative; background-size: cover; background-position: center; min-height: 380px; display:flex; align-items: stretch; }
.hero-overlay { position:absolute; inset:0; background:linear-gradient(135deg,rgba(10,15,25,.85),rgba(18,28,45,.92)); }
.hero-content { position:relative; display:flex; gap:40px; padding:50px 20px; }
.hero-left { width:240px; flex-shrink:0; }
.cover-wrapper { position:relative; }
.hero-cover { width:100%; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.6); border:1px solid rgba(255,255,255,.08); }
.ownership-ribbon { position:absolute; top:10px; left:10px; padding:6px 12px; border-radius:20px; font-size:.75rem; font-weight:600; backdrop-filter:blur(6px); }
.ownership-ribbon.owned { background:rgba(40,167,69,.85); color:#fff; }
.ownership-ribbon.wishlist { background:rgba(13,202,240,.85); color:#061a24; }
.hero-right { flex:1; min-width:0; }
.game-title-display { font-size:2.3rem; font-weight:700; margin:0 0 12px; color:#e6f4ff; letter-spacing:.5px; }
.meta-line { display:flex; flex-wrap:wrap; gap:6px; font-size:.85rem; color:#9fb4c9; }
.meta-item i { margin-right:3px; }
.game-short-desc { margin:18px 0 15px; font-size:.95rem; line-height:1.5; color:#c2d6e7; max-width:820px; }
.action-block .btn { box-shadow:0 6px 18px rgba(102,192,244,.25); }
.price-line { font-size:1rem; font-weight:600; color:#9fd7b4; }
.price-tag { font-size:1.2rem; font-weight:700; color:#9fd7b4; }
.link-accent { color:#66c0f4; text-decoration:none; }
.link-accent:hover { text-decoration:underline; }

/* Panels */
.panel-dark.glassy { background:rgba(20,26,32,.85); border:1px solid rgba(255,255,255,.06); border-radius:12px; }
.section-heading { font-weight:600; margin-bottom:14px; color:#e6f4ff; }
.detail-list { list-style:none; padding:0; margin:0; }
.detail-list li { display:flex; justify-content:space-between; padding:6px 0; font-size:.85rem; border-bottom:1px solid rgba(255,255,255,.05); }
.detail-list li span { color:#9fb4c9; }
.detail-list li strong { color:#e6f4ff; }

/* Screenshots */
.screenshot-strip { display:flex; gap:12px; flex-wrap:wrap; }
.screenshot-strip img { width:240px; height:135px; object-fit:cover; border-radius:8px; border:1px solid rgba(255,255,255,.08); box-shadow:0 4px 12px rgba(0,0,0,.4); transition:.3s; }
.screenshot-strip img:hover { transform:translateY(-4px); box-shadow:0 8px 20px rgba(0,0,0,.55); }

/* Reviews */
.reviews-flow { display:grid; gap:14px; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); }
.review-card { background:rgba(15,20,26,.9); border:1px solid rgba(255,255,255,.05); border-radius:10px; padding:12px 14px; font-size:.8rem; position:relative; overflow:hidden; }
.review-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
.review-user { font-weight:600; color:#e6f4ff; }
.review-date { font-size:.65rem; }
.review-rating { color:#f1c40f; letter-spacing:1px; font-size:.75rem; }
.review-text { color:#b9cad8; margin-top:4px; line-height:1.4; }
.empty-reviews i { opacity:.5; }

/* Feedback form */
.feedback-form select, .feedback-form textarea, .feedback-form input.form-control { background:#10161c; border:1px solid rgba(255,255,255,.1); color:#d5e9f9; }
.feedback-form select:focus, .feedback-form textarea:focus { border-color:#66c0f4; box-shadow:0 0 0 2px rgba(102,192,244,.2); }

/* Responsive */
@@media (max-width: 992px) {
    .hero-content { flex-direction:column; padding:40px 16px; }
    .hero-left { width:180px; margin-bottom:20px; }
    .game-title-display { font-size:2rem; }
}
@@media (max-width: 576px) {
    .hero-left { width:150px; }
    .game-title-display { font-size:1.7rem; }
    .screenshot-strip img { width:46%; height:110px; }
}
</style>
}
